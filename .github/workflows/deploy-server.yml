name: Deploy Server

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-2
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-pdz

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install

      - name: Build
        run: npm run build

      - name: Package build
        run: |
          tar -czf server-build.tgz \
            dist \
            ecosystem.config.js \
            package.json \
            package-lock.json

      - name: Upload artifact to S3
        run: |
          aws s3 cp server-build.tgz s3://pokemondraftzone.api/server-builds/${{ github.sha }}.tgz

      - name: Deploy via SSM
        run: |
          aws ssm send-command \
            --instance-ids "i-0a44924e1ad597b3e" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy pokemon-draftzone-server" \
            --parameters commands='[
              "set -e",
              "sudo -u ubuntu mkdir -p /home/ubuntu/pokemon-draftzone-server",
              "sudo -u ubuntu aws s3 cp s3://pokemondraftzone.api/server-builds/${{ github.sha }}.tgz /home/ubuntu/pokemon-draftzone-server/server-build.tgz",
              "sudo -u ubuntu tar -xzf /home/ubuntu/pokemon-draftzone-server/server-build.tgz -C /home/ubuntu/pokemon-draftzone-server",
              "cd /home/ubuntu/pokemon-draftzone-server",
              "sudo -u ubuntu npm install --omit=dev",
              "sudo -u ubuntu pm2 startOrReload /home/ubuntu/pokemon-draftzone-server/ecosystem.config.js --only pmdz"
            ]'
